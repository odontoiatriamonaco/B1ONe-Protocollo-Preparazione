<!DOCTYPE html>
<html lang="it">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Protocollo B1One Mobile</title>
  <style>
    :root {
      --accent: #0056b3;
      --light-bg: #f4f6f8;
      --white: #ffffff;
      --gray: #dfe4ea;
      --font: 'Segoe UI', 'Roboto', sans-serif;
    }
    body {
      font-family: var(--font);
      margin: 0;
      background: var(--light-bg);
      color: #333;
    }
    header {
      background: linear-gradient(90deg, var(--accent), #007acc);
      color: white;
      padding: 30px 0;
      text-align: center;
      border-bottom: 3px solid #003d80;
    }
    header h1 {
      margin: 0;
      font-size: 28px;
      letter-spacing: 1px;
      text-transform: uppercase;
    }
    header p {
      font-size: 15px;
      font-style: italic;
      margin-top: 5px;
    }
    .container {
      max-width: 1000px;
      margin: 30px auto;
      padding: 20px 30px;
      background: var(--white);
      border-radius: 10px;
      box-shadow: 0 4px 10px rgba(0,0,0,0.06);
    }
    h2 {
      color: var(--accent);
      text-align: center;
      margin-top: 20px;
      font-size: 22px;
    }
    .form-group label {
      font-weight: 600;
      margin-bottom: 6px;
      display: block;
    }
    .form-group input,
    .form-group select {
      width: 100%;
      padding: 10px;
      margin-top: 4px;
      margin-bottom: 16px;
      border: 1px solid var(--gray);
      border-radius: 6px;
      background: #fafafa;
      font-size: 15px;
    }
    
    button {
      padding: 10px 22px;
      font-size: 15px;
      font-weight: 600;
      border: none;
      border-radius: 6px;
      cursor: pointer;
      transition: all 0.3s ease;
    }
    #elaboraBtn { background-color: #28a745; color: white; }
    #resetBtn { background-color: #dc3545; color: white; }
    #pdfBtn { background-color: #007bff; color: white; }
    button:hover { opacity: 0.9; }

    .impianto-card {
      background: #fdfdfd;
      border-left: 5px solid var(--accent);
      padding: 15px 20px;
      border-radius: 8px;
      margin-bottom: 20px;
      box-shadow: 0 1px 4px rgba(0,0,0,0.05);
    }
    .impianto-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      font-weight: 600;
      font-size: 16px;
      margin-bottom: 12px;
    }
    .collapse-btn {
      background: none;
      border: none;
      color: var(--accent);
      font-size: 20px;
      cursor: pointer;
    }
    .result-row {
      background: #f9f9f9;
      border-left: 4px solid var(--accent);
      padding: 16px 20px;
      border-radius: 8px;
      margin-bottom: 20px;
      box-shadow: 0 2px 6px rgba(0,0,0,0.03);
    }
    .result-content {
      display: flex;
      flex-direction: column;
      gap: 8px;
    }
    .result-block {
      font-size: 15px;
    }
    .dente {
      font-weight: bold;
      font-size: 17px;
    }
    .densita {
      font-weight: bold;
    }
    
    body {
      font-family: Arial, sans-serif;
      padding: 10px;
      background: #f4f6f8;
      margin: 0;
      max-width: 100%;
    }
    h1 {
      text-align: center;
      font-size: 24px;
      margin-top: 10px;
      margin-bottom: 5px;
    }
    h3 {
      text-align: center;
      color: blue;
      text-shadow: 1px 1px 2px rgba(0,0,0,0.3);
      margin-top: 0;
      font-style: italic;
      font-size: 16px;
      margin-bottom: 15px;
    }
    .form-group {
      margin-bottom: 15px;
    }
    label {
      font-weight: bold;
      display: block;
      margin-bottom: 5px;
      font-size: 14px;
    }
    input, select {
      width: 100%;
      padding: 10px;
      box-sizing: border-box;
      border: 1px solid #ccc;
      border-radius: 4px;
      font-size: 16px; /* Aumenta dimensione input per mobile */
    }
    
    button {
      flex: 1;
      padding: 12px;
      font-size: 16px;
      cursor: pointer;
      border: none;
      border-radius: 4px;
      font-weight: bold;
    }
    #elaboraBtn {
      background-color: #4CAF50;
      color: white;
    }
    #resetBtn {
      background-color: #f44336;
      color: white;
    }
    #output {
      margin-top: 20px;
    }
    .result-row {
      background: #fff;
      border-radius: 8px;
      padding: 15px;
      margin-bottom: 15px;
      box-shadow: 0 2px 4px rgba(0,0,0,0.1);
    }
    .dente {
      font-size: 22px;
      font-weight: bold;
      text-align: center;
      margin-bottom: 5px;
    }
    .densita {
      font-size: 20px;
      font-weight: bold;
      text-align: center;
      margin-bottom: 10px;
    }
    .result-block {
      font-size: 14px;
      margin-bottom: 8px;
      line-height: 1.4;
    }
    .impianto-card {
      background: #fff;
      border-radius: 8px;
      padding: 15px;
      margin-bottom: 15px;
      box-shadow: 0 2px 4px rgba(0,0,0,0.1);
    }
    .impianto-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 10px;
      border-bottom: 1px solid #eee;
      padding-bottom: 5px;
    }
    .impianto-title {
      font-weight: bold;
      font-size: 16px;
    }
    .nota {
      font-size: 11px;
      color: #666;
      font-style: italic;
      margin-top: 2px;
      margin-bottom: 10px;
    }
    .collapse-btn {
      background: none;
      border: none;
      color: #2196F3;
      cursor: pointer;
      font-size: 22px;
      padding: 0;
    }
    .hidden {
      display: none;
    }
  
    #pdfBtn {
      background-color: #2196F3;
      color: white;
    }
    
.button-container {
  display: flex;
  flex-wrap: wrap;
  justify-content: center;
  gap: 10px;
  margin: 20px 0;
}
.button-container button,
.button-container input[type="file"] + button {
  flex: 1 1 45%;
  padding: 12px;
  font-size: 16px;
  border: none;
  border-radius: 6px;
  font-weight: bold;
  cursor: pointer;
  min-width: 140px;
}
#elaboraBtn { background-color: #28a745; color: white; }
#resetBtn { background-color: #dc3545; color: white; }
#pdfBtn { background-color: #007bff; color: white; }
#saveBtn { background-color: #ffc107; color: black; }


.header-custom {
  background: linear-gradient(135deg, #0056b3, #007acc);
  padding: 30px 15px;
  border-bottom: 4px solid #003d80;
  box-shadow: 0 2px 8px rgba(0,0,0,0.2);
  text-align: center;
  color: white;
  border-radius: 0 0 15px 15px;
}
.header-content h1 {
  margin: 0;
  font-size: 22px;
  letter-spacing: 0.5px;
  text-transform: none;
  font-weight: 700;
}

.header-content h1 {
  text-shadow: 1px 1px 3px rgba(0, 0, 0, 0.4);
}
.header-content p {
  text-shadow: 1px 1px 2px rgba(0, 0, 0, 0.3);
}

.header-content p {
  font-size: 14px;
  font-style: italic;
  margin-top: 8px;
}
@media (min-width: 768px) {
  .header-content h1 {
    font-size: 28px;
  }
  
.header-content h1 {
  text-shadow: 1px 1px 3px rgba(0, 0, 0, 0.4);
}
.header-content p {
  text-shadow: 1px 1px 2px rgba(0, 0, 0, 0.3);
}

.header-content p {
    font-size: 16px;
  }
}

</style>
    
</head>
<body>


<header class="header-custom">
  <div class="header-content">
    <h1>Protocollo di preparazione Impianti B1One</h1>
    <p>Ideato dal Dr. Maurizio Monaco</p>
  </div>
</header>




<div id="finestraContatti" style="display:none; position: fixed; top: 20%; left: 50%; transform: translateX(-50%); background: white; border: 2px solid #007acc; padding: 20px 30px; border-radius: 10px; box-shadow: 0 0 10px rgba(0,0,0,0.2); z-index: 9999; text-align: center;">
  <h3>Contatti</h3>
  <p>Per qualsiasi informazione o dubbio contattare:<br><strong>odontoiatria.monaco@gmail.com</strong></p>
  <button onclick="nascondiContatti()" style="margin-top: 10px; padding: 6px 12px; background-color: #dc3545; color: white; border: none; border-radius: 4px;">Chiudi</button>
</div>

<div class="container">

<div class="form-group">
  <label for="nome">Cognome e Nome del paziente:</label>
  <input type="text" id="nome" placeholder="Inserisci cognome e nome">
</div>

<div class="form-group">
  <label for="impianti">Numero di impianti:</label>
  <select id="impianti" onchange="creaCampiImpianti()">
    <option value="">-- Seleziona --</option>
    <option value="1">1</option>
    <option value="2">2</option>
    <option value="3">3</option>
    <option value="4">4</option>
    <option value="5">5</option>
    <option value="6">6</option>
    <option value="7">7</option>
    <option value="8">8</option>
    <option value="9">9</option>
    <option value="10">10</option>
  </select>
</div>

<div id="impianti-container"></div>

<div class="button-container">
  <input type="file" id="fileInput" accept=".json" style="display:none" onchange="caricaDati(event)">
  <button onclick="document.getElementById('fileInput').click()">üìÇ Carica Dati</button>
  <button id="saveBtn" onclick="salvaDati()">üíæ Salva Dati</button>
  <button id="elaboraBtn" onclick="elabora()">ELABORA</button>
  <button id="resetBtn" onclick="resetta()">RESET</button>
  <button id="pdfBtn" onclick="esportaPDF()">ESPORTA PDF</button>
</div>

<div id="output"></div>

<!-- ACCESSO ADMIN -->
<div style="text-align:right; margin-top:10px;">
  <button onclick="mostraLogin()" style="font-size:13px; padding:5px 10px;">üîí Accesso Admin</button>
</div>

<div id="loginBox" style="display:none; margin-top:10px;">
  <input id="adminUser" type="text" placeholder="Username" style="padding:6px; margin-right:4px;">
  <input id="adminPass" type="password" placeholder="Password" style="padding:6px; margin-right:4px;">
  <button onclick="verificaLogin()" style="padding:6px;">Entra</button>
</div>

<div id="adminArea" style="display:none; margin-top:20px; padding:15px; background:#fff4e6; border:1px solid #ffcc80; border-radius:8px;">
  <h3>Area Amministratore</h3>
  <p>üëÅÔ∏è‚Äçüó®Ô∏è Accessi totali: <span id="accessiCount">0</span></p>
<button onclick="mostraEditorProtocolli()" style="padding:10px; font-size:14px; background:#007acc; color:white; border:none; border-radius:6px;">üõ†Ô∏è Editor Protocolli</button>
  <p>ü¶∑ Impianti elaborati: <span id="impiantiCount">0</span></p>
</div>


<script>
const corpoApiceData = {
  "2.7|High": { corpo: "2,3", apice: "1,3" },
  "3.2|High": { corpo: "2,5", apice: "1,8" },
  "3.7|High": { corpo: "3,0", apice: "2,0" },
  "3.7|Medium": { corpo: "2,9", apice: "2,0" },
  "3.7|Low": { corpo: "2,3", apice: "2,0" },
  "4.2|High": { corpo: "3,5", apice: "2,3" },
  "4.2|Medium": { corpo: "3,4", apice: "2,3" },
  "4.2|Low": { corpo: "2,8", apice: "2,3" },
  "4.8|Medium": { corpo: "4,0", apice: "2,9" },
  "4.8|Low": { corpo: "3,4", apice: "2,9" },
};

function getCorpoApice(diametro, b1one) {
  const key = `${diametro}|${b1one}`;
  if (corpoApiceData[key]) {
    const { corpo, apice } = corpoApiceData[key];
    return ` (corpo √ò${corpo} apice √ò${apice})`;
  }
  return "";
}

function creaCampiImpianti() {
  const num = document.getElementById('impianti').value;
  const container = document.getElementById('impianti-container');
  container.innerHTML = '';
  
  if (!num) return;

  for (let i = 0; i < num; i++) {
    const card = document.createElement('div');
    card.className = 'impianto-card';
    
    // Header con funzionalit√† di collapse
    const header = document.createElement('div');
    header.className = 'impianto-header';
    
    const title = document.createElement('div');
    title.className = 'impianto-title';
    title.textContent = `Impianto ${i+1}`;
    
    const collapseBtn = document.createElement('button');
    collapseBtn.className = 'collapse-btn';
    collapseBtn.textContent = '‚àí';
    collapseBtn.onclick = function() {
      const content = this.parentNode.nextElementSibling;
      if (content.classList.contains('hidden')) {
        content.classList.remove('hidden');
        this.textContent = '‚àí';
      } else {
        content.classList.add('hidden');
        this.textContent = '+';
      }
    };
    
    header.appendChild(title);
    header.appendChild(collapseBtn);
    card.appendChild(header);
    
    // Contenuto della card
    const content = document.createElement('div');
    content.className = 'impianto-content';
    content.innerHTML = `
      <div class="form-group">
        <label for="dente_${i}">Dente:</label>
        <select id="dente_${i}">
          <option value="">-- Seleziona --</option>
          ${[11,12,13,14,15,16,17,18,21,22,23,24,25,26,27,28,31,32,33,34,35,36,37,38,41,42,43,44,45,46,47,48].map(n => `<option value="${n}">${n}</option>`).join('')}
        </select>
      </div>

      <div class="form-group">
        
<label>Seleziona modalit√† input densit√†:</label>
<select onchange="toggleModoInput(this, ${i})" style="margin-bottom: 10px;">
  <option value="hu">Valore Hounsfield</option>
  <option value="densita">Tipo di densit√† ossea</option>
</select>
<div id="hu_block_${i}">
  <label for="hu_${i}">Hounsfield:</label>

        
<input type="number" id="hu_${i}" placeholder="Valore HU">
</div>
<div id="densita_block_${i}" style="display:none;">
  <label for="densita_ossea_${i}">Tipo di densit√† ossea:</label>
  
<select id="densita_ossea_${i}" onchange="impostaHUdaDensita(${i})">
  <option value="">-- seleziona --</option>
  <option value="D1">D1</option>
  <option value="D2_D1">D2 tendente a D1</option>
  <option value="D2">D2</option>
  <option value="D3_D2">D3 tendente a D2</option>
  <option value="D3">D3</option>
  <option value="D3_D4">D4 tendente a D3</option>
  <option value="D4">D4</option>
</select>

</div>

      </div>

      <div class="form-group">
        <label for="carico_${i}">Carico immediato?</label>
        <select id="carico_${i}">
          <option value="non compresso" selected>No</option>
          <option value="compresso">S√¨</option>
        </select>
      </div>

      <div class="form-group">
        <label for="post_${i}">Post-estrattivo?</label>
        <select id="post_${i}">
          <option value="no" selected>No</option>
          <option value="si">S√¨</option>
        </select>
        <div class="nota">In presenza di una radice in posizione impianto il valore HU deve essere controllato (per sovrastima del valore)</div>
      </div>

      <div class="form-group">
        <label for="b1one_${i}">B1One:</label>
        <select id="b1one_${i}" // onchange disattivato: aggiornaOpzioniB1One(${i})">
          <option value="High">High</option>
          <option value="Medium">Medium</option>
          <option value="Low">Low</option>
        </select>
      </div>

      <div class="form-group">
        <label for="diametro_${i}">Diametro (mm):</label>
        <select id="diametro_${i}" onchange="aggiornaTutto(${i}); aggiornaOpzioniB1One(${i}); aggiornaOpzioniLunghezza(${i})">
          <option value="2.7">2.7</option>
          <option value="3.2">3.2</option>
          <option value="3.7">3.7</option>
          <option value="4.2">4.2</option>
          <option value="4.8">4.8</option>
        </select>
      </div>

      <div class="form-group">
        <label for="lunghezza_${i}">Lunghezza (mm):</label>
        <select id="lunghezza_${i}">
          <option value="6">6</option>
          <option value="8">8</option>
          <option value="10">10</option>
          <option value="12">12</option>
          <option value="14">14</option>
          <option value="15.5">15.5</option>
          <option value="17">17</option>
        </select>
      </div>
    `;
    
    card.appendChild(content);
    container.appendChild(card);
  }
  
  // Inizializza le opzioni per tutti gli impianti creati
  for (let i = 0; i < num; i++) {
    aggiornaTutto(i);
    aggiornaOpzioniLunghezza(i);
  }
}

function aggiornaOpzioniB1One(index) {
  // Questa funzione sar√† implementata se necessario
  const b1oneSelect = document.getElementById(`b1one_${index}`);
  const diametroSelect = document.getElementById(`diametro_${index}`);
  
  if (!b1oneSelect || !diametroSelect) return;
  
  const diametro = diametroSelect.value;
  const b1oneValue = b1oneSelect.value;
  
  // Restrizioni per diametro 4.8
  if (diametro === '4.8') {
    // Per 4.8, permettiamo solo Medium e Low
    if (b1oneValue === 'High') {
      b1oneSelect.value = 'Medium';
    }
    
    // Disabilita l'opzione High
    for (let opt of b1oneSelect.options) {
      if (opt.value === 'High') {
        opt.disabled = true;
      } else {
        opt.disabled = false;
      }
    }
  } else {
    // Per tutti gli altri diametri, abilita tutte le opzioni
    for (let opt of b1oneSelect.options) {
      opt.disabled = false;
    }
  }
}


function aggiornaTutto(index) {
  // aggiornaTutto minimal: non fa nulla per evitare errori JS
}


function aggiornaOpzioniLunghezza(index) {
  const diametroSelect = document.getElementById(`diametro_${index}`);
  const lunghezzaSelect = document.getElementById(`lunghezza_${index}`);
  
  if (!diametroSelect || !lunghezzaSelect) return;
  
  const diametro = diametroSelect.value;
  const currentValue = lunghezzaSelect.value;
  
  // Resetta le opzioni
  lunghezzaSelect.innerHTML = '';
  
  if (diametro === '2.7' || diametro === '3.2') {
    // Per 2.7 e 3.2 mostra solo lunghezze da 10mm in su
    lunghezzaSelect.innerHTML += `<option value="10">10</option>`;
    lunghezzaSelect.innerHTML += `<option value="12">12</option>`;
    lunghezzaSelect.innerHTML += `<option value="14">14</option>`;
    lunghezzaSelect.innerHTML += `<option value="15.5">15.5</option>`;
    lunghezzaSelect.innerHTML += `<option value="17">17</option>`;
    
    // Se era selezionato un valore inferiore a 10, passa a 10
    if (currentValue < 10) {
      lunghezzaSelect.value = '10';
    } else {
      // Cerca di ripristinare il valore precedente, se disponibile
      const optionExists = Array.from(lunghezzaSelect.options).some(option => option.value === currentValue);
      lunghezzaSelect.value = optionExists ? currentValue : '10';
    }
  } else if (diametro === '3.7') {
    // Per 3.7 mostra lunghezze da 8mm in su
    lunghezzaSelect.innerHTML += `<option value="8">8</option>`;
    lunghezzaSelect.innerHTML += `<option value="10">10</option>`;
    lunghezzaSelect.innerHTML += `<option value="12">12</option>`;
    lunghezzaSelect.innerHTML += `<option value="14">14</option>`;
    lunghezzaSelect.innerHTML += `<option value="15.5">15.5</option>`;
    lunghezzaSelect.innerHTML += `<option value="17">17</option>`;
    
    // Se era selezionato un valore inferiore a 8, passa a 8
    if (currentValue < 8) {
      lunghezzaSelect.value = '8';
    } else {
      // Cerca di ripristinare il valore precedente, se disponibile
      const optionExists = Array.from(lunghezzaSelect.options).some(option => option.value === currentValue);
      lunghezzaSelect.value = optionExists ? currentValue : '8';
    }
  } else {
    // Per gli altri diametri (4.2 e 4.8) mostra tutte le lunghezze
    lunghezzaSelect.innerHTML += `<option value="6">6</option>`;
    lunghezzaSelect.innerHTML += `<option value="8">8</option>`;
    lunghezzaSelect.innerHTML += `<option value="10">10</option>`;
    lunghezzaSelect.innerHTML += `<option value="12">12</option>`;
    lunghezzaSelect.innerHTML += `<option value="14">14</option>`;
    lunghezzaSelect.innerHTML += `<option value="15.5">15.5</option>`;
    lunghezzaSelect.innerHTML += `<option value="17">17</option>`;
    
    // Ripristina il valore precedente
    // Cerca di ripristinare il valore precedente, se disponibile
    const optionExists = Array.from(lunghezzaSelect.options).some(option => option.value === currentValue);
    lunghezzaSelect.value = optionExists ? currentValue : '6';
  }
}

function getDensitaColor(densita) {
  if (densita.includes('D1') && !densita.includes('D2')) return 'red';
  if (densita.includes('D2') && !densita.includes('D1')) return 'red';
  if (densita.includes('D3') && densita.includes('D2')) return 'darkorange';
  if (densita.includes('D3') && densita.includes('D4')) return 'green';
  if (densita.includes('D2') && densita.includes('D1')) return 'lightcoral';
  if (densita.includes('D3') && !densita.includes('D2') && !densita.includes('D4')) return 'lightsalmon';
  if (densita.includes('D4')) return 'lightgreen';
  return 'black';
}

function getB1OneColor(tipo) {
  if (tipo === 'High') return 'red';
  if (tipo === 'Medium') return 'orange';
  if (tipo === 'Low') return 'green';
  return 'black';
}

function calcolaPreparazione(hu, carico, b1one) {
  // Per impianti B1One High 3.7mm
  if (b1one === 'High') {
    if (hu > 1250) return carico === 'compresso' ? { densita: 'D1', fresa: '3.4', prep: 'Completa' } : { densita: 'D1', fresa: '3.7', prep: 'Completa' };
    if (hu >= 1150) return { densita: 'D2 ‚Üí D1', fresa: '3.4', prep: 'Completa' };
    if (hu >= 850) return carico === 'compresso' ? { densita: 'D2', fresa: '3.2', prep: 'Completa' } : { densita: 'D2', fresa: '3.4', prep: 'Completa' };
    if (hu >= 700) return carico === 'compresso' ? { densita: 'D3 ‚Üí D2', fresa: '3.2', prep: 'Sottopreparazione√ò in altezza (√ò3.2 ‚Äì2 mm, √ò2.3 completa)' } : { densita: 'D3 ‚Üí D2', fresa: '3.2', prep: 'Completa' };
    if (hu >= 500) return carico === 'compresso' ? { densita: 'D3', fresa: '3.0', prep: 'Completa' } : { densita: 'D3', fresa: '3.2', prep: 'Completa' };
    if (hu >= 300) return carico === 'compresso' ? { densita: 'D3 ‚Üí D4', fresa: '2.8', prep: 'Sottopreparazione√ò in altezza (√ò2.8 ‚Äì2 mm, √ò2.0 completa)' } : { densita: 'D3 ‚Üí D4', fresa: '3.0', prep: 'Completa' };
    return carico === 'compresso' ? { densita: 'D4', fresa: '2.3', prep: 'Sottopreparazione√ò in altezza (√ò2.3 ‚Äì2 mm, √ò1.7 completa)' } : { densita: 'D4', fresa: '2.3', prep: 'Completa' };
  }
  // Per impianti B1One Medium 3.7mm
  else if (b1one === 'Medium') {
    if (hu > 1250) return { densita: 'D1', fresa: '3.7', prep: 'Completa' };
    if (hu >= 1150) return carico === 'compresso' ? { densita: 'D2 ‚Üí D1', fresa: '3.4', prep: 'Completa' } : { densita: 'D2 ‚Üí D1', fresa: '3.7', prep: 'Completa' };
    if (hu >= 850) return carico === 'compresso' ? { densita: 'D2', fresa: '3.2', prep: 'Completa' } : { densita: 'D2', fresa: '3.4', prep: 'Completa' };
    if (hu >= 700) return carico === 'compresso' ? { densita: 'D3 ‚Üí D2', fresa: '3.2', prep: 'Sottopreparazione√ò in altezza (√ò3.2 ‚Äì2 mm, √ò2.3 completa)' } : { densita: 'D3 ‚Üí D2', fresa: '3.2', prep: 'Completa' };
    if (hu >= 500) return carico === 'compresso' ? { densita: 'D3', fresa: '3.0', prep: 'Completa' } : { densita: 'D3', fresa: '3.2', prep: 'Completa' };
    if (hu >= 300) return carico === 'compresso' ? { densita: 'D3 ‚Üí D4', fresa: '2.8', prep: 'Sottopreparazione√ò in altezza (√ò2.8 ‚Äì2 mm, √ò2.0 completa)' } : { densita: 'D3 ‚Üí D4', fresa: '3.0', prep: 'Completa' };
    return carico === 'compresso' ? { densita: 'D4', fresa: '2.3', prep: 'Sottopreparazione√ò in altezza (√ò2.3 ‚Äì2 mm, √ò1.7 completa)' } : { densita: 'D4', fresa: '2.3', prep: 'Completa' };
  }
  // Per impianti B1One Low 3.7mm
  else if (b1one === 'Low') {
    if (hu > 1250) return { densita: 'D1', fresa: '3.7', prep: 'Completa' };
    if (hu >= 1150) return { densita: 'D2 ‚Üí D1', fresa: '3.7', prep: 'Completa' };
    if (hu >= 850) return { densita: 'D2', fresa: '3.7', prep: 'Completa' };
    if (hu >= 700) return carico === 'compresso' ? { densita: 'D3 ‚Üí D2', fresa: '3.2', prep: 'Completa' } : { densita: 'D3 ‚Üí D2', fresa: '3.4', prep: 'Completa' };
    if (hu >= 500) return carico === 'compresso' ? { densita: 'D3', fresa: '3.0', prep: 'Completa' } : { densita: 'D3', fresa: '3.2', prep: 'Completa' };
    if (hu >= 300) return carico === 'compresso' ? { densita: 'D3 ‚Üí D4', fresa: '2.8', prep: 'Sottopreparazione√ò in altezza (√ò2.8 ‚Äì2 mm, √ò2.0 completa)' } : { densita: 'D3 ‚Üí D4', fresa: '2.8', prep: 'Completa' };
    return carico === 'compresso' ? { densita: 'D4', fresa: '2.3', prep: 'Sottopreparazione√ò in altezza (√ò2.3 ‚Äì2 mm, √ò1.7 completa)' } : { densita: 'D4', fresa: '2.3', prep: 'Completa' };
  }
}

function calcolaPreparazione42High(hu, carico) {
  if (hu > 1250) return carico === 'compresso' ? { densita: 'D1', fresa: '4.0', prep: 'Completa' } : { densita: 'D1', fresa: '4.2', prep: 'Completa' };
  if (hu >= 1150) return { densita: 'D2 ‚Üí D1', fresa: '4.0', prep: 'Completa' };
  if (hu >= 850) return { densita: 'D2', fresa: '3.8', prep: 'Completa' };
  if (hu >= 700) return carico === 'compresso' ? { densita: 'D3 ‚Üí D2', fresa: '3.6', prep: 'Sottopreparazione√ò (√ò3.6 ‚Äì2 mm, √ò3.0 completa)' } : { densita: 'D3 ‚Üí D2', fresa: '3.6', prep: 'Completa' };
  if (hu >= 500) return carico === 'compresso' ? { densita: 'D3', fresa: '3.4', prep: 'Completa' } : { densita: 'D3', fresa: '3.6', prep: 'Sottopreparazione√ò (√ò3.6 ‚Äì2 mm, √ò3.0 completa)' };
  if (hu >= 300) return carico === 'compresso' ? { densita: 'D3 ‚Üí D4', fresa: '3.0', prep: 'Sottopreparazione√ò (√ò3.0 ‚Äì2 mm, √ò2.3 completa)' } : { densita: 'D3 ‚Üí D4', fresa: '3.4', prep: 'Completa' };
  return { densita: 'D4', fresa: '2.8', prep: 'Completa' };
}

function calcolaPreparazione42Medium(hu, carico) {
  if (hu > 1250) return { densita: 'D1', fresa: '4.2', prep: 'Completa' };
  if (hu >= 1150) return carico === 'compresso' ? { densita: 'D2 ‚Üí D1', fresa: '4.0', prep: 'Completa' } : { densita: 'D2 ‚Üí D1', fresa: '4.2', prep: 'Completa' };
  if (hu >= 850) return carico === 'compresso' ? { densita: 'D2', fresa: '3.8', prep: 'Completa' } : { densita: 'D2', fresa: '4.0', prep: 'Completa' };
  if (hu >= 700) return carico === 'compresso' ? { densita: 'D3 ‚Üí D2', fresa: '3.6', prep: 'Sottopreparazione√ò (√ò3.6 ‚Äì2 mm, √ò3.0 completa)' } : { densita: 'D3 ‚Üí D2', fresa: '3.8', prep: 'Completa' };
  if (hu >= 500) return carico === 'compresso' ? { densita: 'D3', fresa: '3.4', prep: 'Completa' } : { densita: 'D3', fresa: '3.6', prep: 'Sottopreparazione√ò (√ò3.6 ‚Äì2 mm, √ò3.0 completa)' };
  if (hu >= 300) return carico === 'compresso' ? { densita: 'D3 ‚Üí D4', fresa: '3.0', prep: 'Sottopreparazione√ò (√ò3.0 ‚Äì2 mm, √ò2.3 completa)' } : { densita: 'D3 ‚Üí D4', fresa: '3.4', prep: 'Completa' };
  return carico === 'compresso' ? { densita: 'D4', fresa: 'F.lettrice', prep: 'Completa' } : { densita: 'D4', fresa: '2.8', prep: 'Completa' };
}

// Per impianti B1One Low 4.2mm
function calcolaPreparazione42Low(hu, carico) {
  if (hu > 1250) return { densita: 'D1', fresa: '4.2', prep: 'Completa' };
  if (hu >= 1150) return carico === 'compresso'
    ? { densita: 'D2 ‚Üí D1', fresa: '4.0', prep: 'Completa' }
    : { densita: 'D2 ‚Üí D1', fresa: '4.2', prep: 'Completa' };
  if (hu >= 850) return carico === 'compresso'
    ? { densita: 'D2', fresa: '3.4', prep: 'Completa' }
    : { densita: 'D2', fresa: '3.6', prep: 'Completa' };
  if (hu >= 700) return carico === 'compresso'
    ? { densita: 'D3 ‚Üí D2', fresa: '3.0', prep: 'Completa' }
    : { densita: 'D3 ‚Üí D2', fresa: '3.2', prep: 'Completa' };
  if (hu >= 500) return carico === 'compresso'
    ? { densita: 'D3', fresa: '2.8', prep: 'Completa' }
    : { densita: 'D3', fresa: '3.0', prep: 'Sottopreparazione√ò in altezza (√ò3.0 ‚Äì2 mm, √ò 2.3 completa)' };
  if (hu >= 300) return carico === 'compresso'
    ? { densita: 'D3 ‚Üí D4', fresa: 'F.lettrice', prep: 'Completa' }
    : { densita: 'D3 ‚Üí D4', fresa: '2.8', prep: 'Completa' };
  return carico === 'compresso'
    ? { densita: 'D4', fresa: '2.3', prep: 'Completa' }
    : { densita: 'D4', fresa: 'F.lettrice', prep: 'Completa' };
}


function calcolaPreparazione48Medium(hu, carico) {
  if (hu > 1250) return { densita: 'D1', fresa: '4.8', prep: 'Completa' };
  if (hu >= 1150) return { densita: 'D2 ‚Üí D1', fresa: '4.8', prep: 'Completa' };
  if (hu >= 850) return carico === 'compresso' ? { densita: 'D2', fresa: '4.4', prep: 'Completa' } : { densita: 'D2', fresa: '4.8', prep: 'Completa' };
  if (hu >= 700) return carico === 'compresso' ? { densita: 'D3 ‚Üí D2', fresa: '4.4', prep: 'Sottopreparazione√ò in altezza (√ò4.4 ‚Äì2 mm, √ò3.0 completa)' } : { densita: 'D3 ‚Üí D2', fresa: '4.4', prep: 'Completa' };
  if (hu >= 500) return carico === 'compresso' ? { densita: 'D3', fresa: '4.2', prep: 'Completa' } : { densita: 'D3', fresa: '4.4', prep: 'Sottopreparazione√ò in altezza (√ò4.4 ‚Äì2 mm, √ò3.0 completa)' };
  if (hu >= 300) return carico === 'compresso' ? { densita: 'D3 ‚Üí D4', fresa: '3.8', prep: 'Sottopreparazione√ò in altezza (√ò3.8 ‚Äì2 mm, √ò3.0 completa)' } : { densita: 'D3 ‚Üí D4', fresa: '4.2', prep: 'Completa' };
  return carico === 'compresso' ? { densita: 'D4', fresa: '3.6', prep: 'Sottopreparazione√ò in altezza (√ò3.6 ‚Äì2 mm, √ò3.0 completa)' } : { densita: 'D4', fresa: '3.8', prep: 'Completa' };
}

function calcolaPreparazione48Low(hu, carico) {
  if (hu > 1250) return { densita: 'D1', fresa: '4.8', prep: 'Completa' };
  if (hu >= 1150) return { densita: 'D2 ‚Üí D1', fresa: '4.8', prep: 'Completa' };
  if (hu >= 850) return carico === 'compresso' ? { densita: 'D2', fresa: '4.4', prep: 'Completa' } : { densita: 'D2', fresa: '4.8', prep: 'Completa' };
  if (hu >= 700) return carico === 'compresso' ? { densita: 'D3 ‚Üí D2', fresa: '4.2', prep: 'Sottopreparazione√ò in altezza (√ò4.4 ‚Äì2 mm, √ò3.0 completa)' } : { densita: 'D3 ‚Üí D2', fresa: '4.4', prep: 'Completa' };
  if (hu >= 500) return carico === 'compresso' ? { densita: 'D3', fresa: '3.8', prep: 'Completa' } : { densita: 'D3', fresa: '4.2', prep: 'Sottopreparazione√ò in altezza (√ò4.4 ‚Äì2 mm, √ò3.0 completa)' };
  if (hu >= 300) return carico === 'compresso' ? { densita: 'D3 ‚Üí D4', fresa: '3.6', prep: 'Sottopreparazione√ò in altezza (√ò3.6 ‚Äì2 mm, √ò3.0 completa)' } : { densita: 'D3 ‚Üí D4', fresa: '3.8', prep: 'Completa' };
  return carico === 'compresso' ? { densita: 'D4', fresa: '3.4', prep: 'Sottopreparazione√ò in altezza (√ò3.4 ‚Äì2 mm, √ò3.0 completa)' } : { densita: 'D4', fresa: '3.6', prep: 'Completa' };
}

function calcolaPreparazione27High(hu, carico) {
  if (hu > 1250) return carico === 'compresso' ? { densita: 'D1', fresa: '2.0', prep: 'Completa' } : { densita: 'D1', fresa: '2.3', prep: 'Completa' };
  if (hu >= 1150) return carico === 'compresso' ? { densita: 'D2 ‚Üí D1', fresa: '2.0', prep: 'Completa' } : { densita: 'D2 ‚Üí D1', fresa: '2.3', prep: 'Completa' };
  if (hu >= 850) return carico === 'compresso' ? { densita: 'D2', fresa: '2.0', prep: 'Sottopreparazione√ò in altezza (√ò2.0 ‚Äì2 mm, √ò1,7 completa)' } : { densita: 'D2', fresa: '2.0', prep: 'Completa' };
  if (hu >= 700) return carico === 'compresso' ? { densita: 'D3 ‚Üí D2', fresa: '1.7', prep: 'Completa' } : { densita: 'D3 ‚Üí D2', fresa: '2.0', prep: 'Completa' };
  if (hu >= 500) return { densita: 'D3', fresa: '1.7', prep: 'Completa' };
  if (hu >= 300) return carico === 'compresso' ? { densita: 'D3 ‚Üí D4', fresa: '1.7', prep: 'Sottopreparazione in altezza (‚Äì1 mm)' } : { densita: 'D3 ‚Üí D4', fresa: '1.7', prep: 'Completa' };
  return { densita: 'D4', fresa: '1.7', prep: '2‚Äì3 mm meno in profondit√†' };
}

function calcolaPreparazione32High(hu, carico) {
  if (hu > 1250) return carico === 'compresso' ? { densita: 'D1', fresa: '2.3', prep: 'Completa' } : { densita: 'D1', fresa: '2.8', prep: 'Completa' };
  if (hu >= 1150) return { densita: 'D2 ‚Üí D1', fresa: '2.3', prep: 'Completa' };
  if (hu >= 850) return carico === 'compresso' ? { densita: 'D2', fresa: '2.0', prep: 'Completa' } : { densita: 'D2', fresa: '2.3', prep: 'Completa' };
  if (hu >= 700) return { densita: 'D3 ‚Üí D2', fresa: '2.0', prep: 'Completa' };
  if (hu >= 500) return carico === 'compresso' ? { densita: 'D3', fresa: '1.7', prep: 'Completa' } : { densita: 'D3', fresa: '2.0', prep: 'Completa' };
  if (hu >= 300) return carico === 'compresso' ? { densita: 'D3 ‚Üí D4', fresa: '1.7', prep: '2‚Äì3 mm meno in profondit√†' } : { densita: 'D3 ‚Üí D4', fresa: '1.7', prep: 'Completa' };
  return { densita: 'D4', fresa: '1.7', prep: carico === 'compresso' ? '2‚Äì3 mm meno in profondit√†' : 'Completa' };
}


function getImpiantoIdeale(diametro, densita) {
  const tipo = (() => {
    if (["3.7", "4.2", "4.8"].includes(diametro)) {
      if (["D1", "D2", "D1‚ÜíD1"].includes(densita)) return "High";
      if (["D3", "D3‚ÜíD2"].includes(densita)) return "Medium";
      if (["D4", "D3‚ÜíD4"].includes(densita)) return "Low";
    }
    return null;
  })();

  if (!tipo) return "";

  const colore = {
    High: "#e74c3c",
    Medium: "#ff8800",
    Low: "#28a745"
  }[tipo];

  return `<div class="result-block"><strong>Impianto ideale:</strong> <span style="color:${colore}; font-weight:bold;">B1One ${tipo} (√ò${diametro})</span></div>`;
}




function elabora() {
  console.log("‚ñ∂Ô∏è ELABORA ATTIVATA");
  const num = document.getElementById('impianti').value;
  const risultatiContainer = document.getElementById('risultati');
  risultatiContainer.innerHTML = '';

  const nome = document.getElementById('nome').value || 'Paziente Sconosciuto';
  const intestazione = document.createElement("div");
  intestazione.innerHTML = `<h2>Risultati per: ${nome}</h2>`;
  risultatiContainer.appendChild(intestazione);

  for (let i = 0; i < num; i++) {
    const dente = document.getElementById(`dente_${i}`)?.value || 'ND';
    const hu = parseInt(document.getElementById(`hu_${i}`)?.value || 0);
    const carico = document.getElementById(`carico_${i}`)?.value || 'ND';
    const post = document.getElementById(`post_${i}`)?.value || 'ND';
    const b1one = document.getElementById(`b1one_${i}`)?.value || 'ND';
    const diametro = document.getElementById(`diametro_${i}`)?.value || 'ND';
    const lunghezza = document.getElementById(`lunghezza_${i}`)?.value || 'ND';

    const result = getPreparazioneDaEditor(diametro, b1one, hu, carico);
    const colore = getColoreDensita(getDensitaFromHU(hu));

    const div = document.createElement("div");
    div.innerHTML = `<h3>Impianto ${i + 1} (Dente ${dente})</h3>
                     <p style="text-align:center; font-size:22px; font-weight:bold; color:${colore};"><strong>Densit√† ossea:</strong> ${getDensitaFromHU(hu)}</p>
                     ${getImpiantoIdealeLabel(getDensitaFromHU(hu), diametro)}
<p style="color:${getB1OneColor(b1one)}; font-weight:bold;">B1One ${diametro} ${b1one}${getCorpoApice(diametro, b1one)}</p>

${post === "si" ? '<p style="color:purple; font-weight:bold;">Post-estrattivo: controllare la densit√† ossea, perch√© la sovrapposizione alla radice sovrastima il valore HU</p>' : ""}

                     <p><strong>Carico:</strong> ${carico}</p>
                     <p><strong>Fresa finale √ò:</strong> ${result.fresa}</p>
                     <p><strong>Preparazione in lunghezza:</strong> ${result.prep}</p><hr>`;
    risultatiContainer.appendChild(div);
  }
}

function resetta() {
  document.getElementById('nome').value = '';
  document.getElementById('impianti').value = '';
  document.getElementById('impianti-container').innerHTML = '';
  document.getElementById('output').innerHTML = '';
  const risultati = document.getElementById('risultati');
  if (risultati) risultati.innerHTML = '';
}



function salvaDati() {
  const nome = document.getElementById('nome').value || 'paziente';
  const num = document.getElementById('impianti').value;
  if (!num) {
    alert("Inserisci almeno un impianto prima di salvare.");
    return;
  }

  const dati = {
    paziente: nome,
    impianti: []
  };

  for (let i = 0; i < num; i++) {
    dati.impianti.push({
      dente: document.getElementById(`dente_${i}`).value,
      hu: document.getElementById(`hu_${i}`).value,
      carico: document.getElementById(`carico_${i}`).value,
      post: document.getElementById(`post_${i}`).value,
      b1one: document.getElementById(`b1one_${i}`).value,
      diametro: document.getElementById(`diametro_${i}`).value,
      lunghezza: document.getElementById(`lunghezza_${i}`).value
    });
  }

  const blob = new Blob([JSON.stringify(dati, null, 2)], { type: "application/json" });
  const url = URL.createObjectURL(blob);
  const a = document.createElement("a");
  a.href = url;
  a.download = `Dati_${nome.replace(/\s+/g, "_")}.json`;
  a.click();
  URL.revokeObjectURL(url);
}


function caricaDati(event) {
  const file = event.target.files[0];
  if (!file) return;

  const reader = new FileReader();
  reader.onload = function(e) {
    try {
      const dati = JSON.parse(e.target.result);
      document.getElementById('nome').value = dati.paziente || '';
      document.getElementById('impianti').value = dati.impianti.length;
      creaCampiImpianti();

      setTimeout(() => {
        dati.impianti.forEach((impianto, i) => {
          document.getElementById(`dente_${i}`).value = impianto.dente || '';
          document.getElementById(`hu_${i}`).value = impianto.hu || '';
          document.getElementById(`carico_${i}`).value = impianto.carico || '';
          document.getElementById(`post_${i}`).value = impianto.post || '';
          document.getElementById(`b1one_${i}`).value = impianto.b1one || '';
          document.getElementById(`diametro_${i}`).value = impianto.diametro || '';
          aggiornaTutto(i);
    aggiornaOpzioniLunghezza(i);
          document.getElementById(`lunghezza_${i}`).value = impianto.lunghezza || '';
        });
      }, 100);
    } catch (err) {
      alert("Errore nel file caricato. Verifica che sia un file JSON valido.");
    }
  };
  reader.readAsText(file);
}



function getColoreDensita(testo) {
  if (testo.includes("D1") || testo.includes("D2 ‚Üí D1") || testo === "D2") {
    return "#c0392b"; // rosso
  } else if (testo.includes("D3 ‚Üí D2") || testo === "D3") {
    return "#e67e22"; // arancione
  } else if (testo.includes("D3 ‚Üí D4") || testo.includes("D4")) {
    return "#27ae60"; // verde
  }
  return "#000000";
}


function getImpiantoIdealeLabel(densita, diametro) {
  let tipo = "";
  if (["D1", "D2 tendente D1", "D2", "D2 ‚Üí D1"].includes(densita)) tipo = "High";
  else if (["D3", "D3 tendente D2", "D3 ‚Üí D2"].includes(densita)) tipo = "Medium";
  else if (["D4", "D4 tendente D3", "D3 ‚Üí D4"].includes(densita)) tipo = "Low";
  else tipo = "ND";

  const colori = {
    "High": "red",
    "Medium": "orange",
    "Low": "green",
    "ND": "black"
  };

  return `<p style="color:${colori[tipo]}; font-weight:bold;"><strong>Impianto ideale:</strong> B1One ${tipo}</p>`;
}


function esportaProtocolliPDF() {
  const editor = document.getElementById('tabelleEditor');
  if (!editor) {
    alert("Editor non trovato.");
    return;
  }

  html2canvas(editor, { scale: 2 }).then(canvas => {
    const imgData = canvas.toDataURL('image/jpeg', 1.0);
    const pdf = new jspdf.jsPDF('p', 'mm', 'a4');
    const pageWidth = pdf.internal.pageSize.getWidth();
    const pageHeight = pdf.internal.pageSize.getHeight();
    const imgProps = pdf.getImageProperties(imgData);
    const imgHeight = (imgProps.height * (pageWidth - 20)) / imgProps.width;

    let position = 0;

    while (position < imgHeight) {
      pdf.addImage(imgData, 'JPEG', 10, -position, pageWidth - 20, imgHeight);
      position += pageHeight;
      if (position < imgHeight) pdf.addPage();
    }

    pdf.save("Protocolli_Impianti_B1One.pdf");
  });
}

</script>


<script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js">
function getImpiantoIdealeLabel(densita, diametro) {
  let tipo = "";
  if (["D1", "D2 tendente D1", "D2", "D2 ‚Üí D1"].includes(densita)) tipo = "High";
  else if (["D3", "D3 tendente D2", "D3 ‚Üí D2"].includes(densita)) tipo = "Medium";
  else if (["D4", "D4 tendente D3", "D3 ‚Üí D4"].includes(densita)) tipo = "Low";
  else tipo = "ND";

  const colori = {
    "High": "red",
    "Medium": "orange",
    "Low": "green",
    "ND": "black"
  };

  return `<p style="color:${colori[tipo]}; font-weight:bold;"><strong>Impianto ideale:</strong> B1One ${tipo}</p>`;
}


function esportaProtocolliPDF() {
  const editor = document.getElementById('tabelleEditor');
  if (!editor) {
    alert("Editor non trovato.");
    return;
  }

  html2canvas(editor, { scale: 2 }).then(canvas => {
    const imgData = canvas.toDataURL('image/jpeg', 1.0);
    const pdf = new jspdf.jsPDF('p', 'mm', 'a4');
    const pageWidth = pdf.internal.pageSize.getWidth();
    const pageHeight = pdf.internal.pageSize.getHeight();
    const imgProps = pdf.getImageProperties(imgData);
    const imgHeight = (imgProps.height * (pageWidth - 20)) / imgProps.width;

    let position = 0;

    while (position < imgHeight) {
      pdf.addImage(imgData, 'JPEG', 10, -position, pageWidth - 20, imgHeight);
      position += pageHeight;
      if (position < imgHeight) pdf.addPage();
    }

    pdf.save("Protocolli_Impianti_B1One.pdf");
  });
}

</script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js">
function getImpiantoIdealeLabel(densita, diametro) {
  let tipo = "";
  if (["D1", "D2 tendente D1", "D2", "D2 ‚Üí D1"].includes(densita)) tipo = "High";
  else if (["D3", "D3 tendente D2", "D3 ‚Üí D2"].includes(densita)) tipo = "Medium";
  else if (["D4", "D4 tendente D3", "D3 ‚Üí D4"].includes(densita)) tipo = "Low";
  else tipo = "ND";

  const colori = {
    "High": "red",
    "Medium": "orange",
    "Low": "green",
    "ND": "black"
  };

  return `<p style="color:${colori[tipo]}; font-weight:bold;"><strong>Impianto ideale:</strong> B1One ${tipo}</p>`;
}


function esportaProtocolliPDF() {
  const editor = document.getElementById('tabelleEditor');
  if (!editor) {
    alert("Editor non trovato.");
    return;
  }

  html2canvas(editor, { scale: 2 }).then(canvas => {
    const imgData = canvas.toDataURL('image/jpeg', 1.0);
    const pdf = new jspdf.jsPDF('p', 'mm', 'a4');
    const pageWidth = pdf.internal.pageSize.getWidth();
    const pageHeight = pdf.internal.pageSize.getHeight();
    const imgProps = pdf.getImageProperties(imgData);
    const imgHeight = (imgProps.height * (pageWidth - 20)) / imgProps.width;

    let position = 0;

    while (position < imgHeight) {
      pdf.addImage(imgData, 'JPEG', 10, -position, pageWidth - 20, imgHeight);
      position += pageHeight;
      if (position < imgHeight) pdf.addPage();
    }

    pdf.save("Protocolli_Impianti_B1One.pdf");
  });
}

</script>
<script>
async function esportaPDF() {
  const nome = document.getElementById('nome').value || 'paziente';
  const output = document.getElementById('risultati');

  if (!output.innerHTML.trim()) {
    alert("Non ci sono risultati da esportare. Premi 'ELABORA' prima.");
    return;
  }

  html2canvas(output, { scale: 2 }).then(canvas => {
    const imgData = canvas.toDataURL('image/jpeg', 1.0);
    const pdf = new jspdf.jsPDF('p', 'mm', 'a4');
    const pageWidth = pdf.internal.pageSize.getWidth();
    const pageHeight = pdf.internal.pageSize.getHeight();
    const imgProps = pdf.getImageProperties(imgData);
    const imgHeight = (imgProps.height * pageWidth) / imgProps.width;

    let position = 0;

    while (position < imgHeight) {
      pdf.addImage(imgData, 'JPEG', 10, -position, pageWidth - 20, imgHeight);
      position += pageHeight;
      if (position < imgHeight) pdf.addPage();
    }

    pdf.save(`Protocollo_B1One_${nome.replace(/\s+/g, '_')}.pdf`);
  });
}

// Chiavi localStorage
const accessiKey = "contatoreAccessi";
const impiantiKey = "impiantiElaborati";

// Incrementa accessi a ogni visita
window.onload = () => {

fetch("preparazione.json")
  .then(response => response.json())
  .then(dati => {
    document.getElementById('nome').value = dati.paziente || '';
    document.getElementById('impianti').value = dati.impianti.length;
    creaCampiImpianti();
    setTimeout(() => {
      dati.impianti.forEach((impianto, i) => {
        document.getElementById(`dente_${i}`).value = impianto.dente || '';
        document.getElementById(`hu_${i}`).value = impianto.hu || '';
        document.getElementById(`carico_${i}`).value = impianto.carico || '';
        document.getElementById(`post_${i}`).value = impianto.post || '';
        document.getElementById(`b1one_${i}`).value = impianto.b1one || '';
        document.getElementById(`diametro_${i}`).value = impianto.diametro || '';
        aggiornaTutto(i);
        aggiornaOpzioniLunghezza(i);
        document.getElementById(`lunghezza_${i}`).value = impianto.lunghezza || '';
      });
    }, 100);
  })
  .catch(err => console.warn("‚ö†Ô∏è File preparazione.json non trovato o errore di lettura.", err));


  let acc = parseInt(localStorage.getItem(accessiKey)) || 0;
  acc++;
  localStorage.setItem(accessiKey, acc);
};

// Mostra login box
function mostraLogin() {
  document.getElementById("loginBox").style.display = "block";
}

// Verifica login
function verificaLogin() {
  const user = document.getElementById("adminUser").value;
  const pass = document.getElementById("adminPass").value;

  if (user === "admin" && pass === "b1admin") {
    mostraAdmin();
    document.getElementById("loginBox").style.display = "none";
  } else {
    alert("Credenziali errate.");
  }
}

// Mostra area admin
function mostraAdmin() {
  const accessi = localStorage.getItem(accessiKey) || 0;
  const impianti = localStorage.getItem(impiantiKey) || 0;
  document.getElementById("accessiCount").textContent = accessi;
  document.getElementById("impiantiCount").textContent = impianti;
  document.getElementById("adminArea").style.display = "block";
}



function salvaDati() {
  const nome = document.getElementById('nome').value || 'paziente';
  const num = document.getElementById('impianti').value;
  if (!num) {
    alert("Inserisci almeno un impianto prima di salvare.");
    return;
  }

  const dati = {
    paziente: nome,
    impianti: []
  };

  for (let i = 0; i < num; i++) {
    dati.impianti.push({
      dente: document.getElementById(`dente_${i}`).value,
      hu: document.getElementById(`hu_${i}`).value,
      carico: document.getElementById(`carico_${i}`).value,
      post: document.getElementById(`post_${i}`).value,
      b1one: document.getElementById(`b1one_${i}`).value,
      diametro: document.getElementById(`diametro_${i}`).value,
      lunghezza: document.getElementById(`lunghezza_${i}`).value
    });
  }

  const blob = new Blob([JSON.stringify(dati, null, 2)], { type: "application/json" });
  const url = URL.createObjectURL(blob);
  const a = document.createElement("a");
  a.href = url;
  a.download = `Dati_${nome.replace(/\s+/g, "_")}.json`;
  a.click();
  URL.revokeObjectURL(url);
}


function caricaDati(event) {
  const file = event.target.files[0];
  if (!file) return;

  const reader = new FileReader();
  reader.onload = function(e) {
    try {
      const dati = JSON.parse(e.target.result);
      document.getElementById('nome').value = dati.paziente || '';
      document.getElementById('impianti').value = dati.impianti.length;
      creaCampiImpianti();

      setTimeout(() => {
        dati.impianti.forEach((impianto, i) => {
          document.getElementById(`dente_${i}`).value = impianto.dente || '';
          document.getElementById(`hu_${i}`).value = impianto.hu || '';
          document.getElementById(`carico_${i}`).value = impianto.carico || '';
          document.getElementById(`post_${i}`).value = impianto.post || '';
          document.getElementById(`b1one_${i}`).value = impianto.b1one || '';
          document.getElementById(`diametro_${i}`).value = impianto.diametro || '';
          aggiornaTutto(i);
    aggiornaOpzioniLunghezza(i);
          document.getElementById(`lunghezza_${i}`).value = impianto.lunghezza || '';
        });
      }, 100);
    } catch (err) {
      alert("Errore nel file caricato. Verifica che sia un file JSON valido.");
    }
  };
  reader.readAsText(file);
}


function getImpiantoIdealeLabel(densita, diametro) {
  let tipo = "";
  if (["D1", "D2 tendente D1", "D2", "D2 ‚Üí D1"].includes(densita)) tipo = "High";
  else if (["D3", "D3 tendente D2", "D3 ‚Üí D2"].includes(densita)) tipo = "Medium";
  else if (["D4", "D4 tendente D3", "D3 ‚Üí D4"].includes(densita)) tipo = "Low";
  else tipo = "ND";

  const colori = {
    "High": "red",
    "Medium": "orange",
    "Low": "green",
    "ND": "black"
  };

  return `<p style="color:${colori[tipo]}; font-weight:bold;"><strong>Impianto ideale:</strong> B1One ${tipo}</p>`;
}


function esportaProtocolliPDF() {
  const editor = document.getElementById('tabelleEditor');
  if (!editor) {
    alert("Editor non trovato.");
    return;
  }

  html2canvas(editor, { scale: 2 }).then(canvas => {
    const imgData = canvas.toDataURL('image/jpeg', 1.0);
    const pdf = new jspdf.jsPDF('p', 'mm', 'a4');
    const pageWidth = pdf.internal.pageSize.getWidth();
    const pageHeight = pdf.internal.pageSize.getHeight();
    const imgProps = pdf.getImageProperties(imgData);
    const imgHeight = (imgProps.height * (pageWidth - 20)) / imgProps.width;

    let position = 0;

    while (position < imgHeight) {
      pdf.addImage(imgData, 'JPEG', 10, -position, pageWidth - 20, imgHeight);
      position += pageHeight;
      if (position < imgHeight) pdf.addPage();
    }

    pdf.save("Protocolli_Impianti_B1One.pdf");
  });
}

</script>







<!-- Bottone CONTATTI -->
<div style="position: fixed; bottom: 20px; right: 20px; z-index: 999;">
  <button onclick="mostraContatti()" style="background-color: #4CAF50; color: white; padding: 10px 16px; border: none; border-radius: 6px; font-weight: bold; font-size: 14px; cursor: pointer;">
    üì¨ Contatti
  </button>
</div>


<!-- Bottone ISTRUZIONI -->
<div style="position: fixed; bottom: 20px; left: 20px; z-index: 999;">
  <a href="Tutorial.pdf" target="_blank" rel="noopener noreferrer" type="application/pdf" style="text-decoration: none;">
    <button style="background-color: orange; color: white; padding: 10px 16px; border: none; border-radius: 6px; font-weight: bold; font-size: 14px; cursor: pointer;">
      üìÑ Istruzioni
    </button>
  </a>
</div>


<script>
function mostraContatti() {
  const box = document.getElementById("finestraContatti");
  if (box) box.style.display = "block";
}
function nascondiContatti() {
  const box = document.getElementById("finestraContatti");
  if (box) box.style.display = "none";
}


function salvaDati() {
  const nome = document.getElementById('nome').value || 'paziente';
  const num = document.getElementById('impianti').value;
  if (!num) {
    alert("Inserisci almeno un impianto prima di salvare.");
    return;
  }

  const dati = {
    paziente: nome,
    impianti: []
  };

  for (let i = 0; i < num; i++) {
    dati.impianti.push({
      dente: document.getElementById(`dente_${i}`).value,
      hu: document.getElementById(`hu_${i}`).value,
      carico: document.getElementById(`carico_${i}`).value,
      post: document.getElementById(`post_${i}`).value,
      b1one: document.getElementById(`b1one_${i}`).value,
      diametro: document.getElementById(`diametro_${i}`).value,
      lunghezza: document.getElementById(`lunghezza_${i}`).value
    });
  }

  const blob = new Blob([JSON.stringify(dati, null, 2)], { type: "application/json" });
  const url = URL.createObjectURL(blob);
  const a = document.createElement("a");
  a.href = url;
  a.download = `Dati_${nome.replace(/\s+/g, "_")}.json`;
  a.click();
  URL.revokeObjectURL(url);
}


function caricaDati(event) {
  const file = event.target.files[0];
  if (!file) return;

  const reader = new FileReader();
  reader.onload = function(e) {
    try {
      const dati = JSON.parse(e.target.result);
      document.getElementById('nome').value = dati.paziente || '';
      document.getElementById('impianti').value = dati.impianti.length;
      creaCampiImpianti();

      setTimeout(() => {
        dati.impianti.forEach((impianto, i) => {
          document.getElementById(`dente_${i}`).value = impianto.dente || '';
          document.getElementById(`hu_${i}`).value = impianto.hu || '';
          document.getElementById(`carico_${i}`).value = impianto.carico || '';
          document.getElementById(`post_${i}`).value = impianto.post || '';
          document.getElementById(`b1one_${i}`).value = impianto.b1one || '';
          document.getElementById(`diametro_${i}`).value = impianto.diametro || '';
          aggiornaTutto(i);
    aggiornaOpzioniLunghezza(i);
          document.getElementById(`lunghezza_${i}`).value = impianto.lunghezza || '';
        });
      }, 100);
    } catch (err) {
      alert("Errore nel file caricato. Verifica che sia un file JSON valido.");
    }
  };
  reader.readAsText(file);
}


function getImpiantoIdealeLabel(densita, diametro) {
  let tipo = "";
  if (["D1", "D2 tendente D1", "D2", "D2 ‚Üí D1"].includes(densita)) tipo = "High";
  else if (["D3", "D3 tendente D2", "D3 ‚Üí D2"].includes(densita)) tipo = "Medium";
  else if (["D4", "D4 tendente D3", "D3 ‚Üí D4"].includes(densita)) tipo = "Low";
  else tipo = "ND";

  const colori = {
    "High": "red",
    "Medium": "orange",
    "Low": "green",
    "ND": "black"
  };

  return `<p style="color:${colori[tipo]}; font-weight:bold;"><strong>Impianto ideale:</strong> B1One ${tipo}</p>`;
}


function esportaProtocolliPDF() {
  const editor = document.getElementById('tabelleEditor');
  if (!editor) {
    alert("Editor non trovato.");
    return;
  }

  html2canvas(editor, { scale: 2 }).then(canvas => {
    const imgData = canvas.toDataURL('image/jpeg', 1.0);
    const pdf = new jspdf.jsPDF('p', 'mm', 'a4');
    const pageWidth = pdf.internal.pageSize.getWidth();
    const pageHeight = pdf.internal.pageSize.getHeight();
    const imgProps = pdf.getImageProperties(imgData);
    const imgHeight = (imgProps.height * (pageWidth - 20)) / imgProps.width;

    let position = 0;

    while (position < imgHeight) {
      pdf.addImage(imgData, 'JPEG', 10, -position, pageWidth - 20, imgHeight);
      position += pageHeight;
      if (position < imgHeight) pdf.addPage();
    }

    pdf.save("Protocolli_Impianti_B1One.pdf");
  });
}

</script>


<script>
function toggleModoInput(select, i) {
  const huBlock = document.getElementById(`hu_block_${i}`);
  const densitaBlock = document.getElementById(`densita_block_${i}`);
  if (select.value === "hu") {
    huBlock.style.display = "block";
    densitaBlock.style.display = "none";
    document.getElementById(`densita_ossea_${i}`).value = "";
  } else {
    huBlock.style.display = "none";
    densitaBlock.style.display = "block";
    document.getElementById(`hu_${i}`).value = "";
  }
}

function impostaHUdaDensita(i) {
  const valore = document.getElementById(`densita_ossea_${i}`).value;
  const campoHU = document.getElementById(`hu_${i}`);
  
  const mappa = {
    "D1": 1300,
    "D2_D1": 1200,
    "D2": 1000,
    "D3_D2": 775,
    "D3": 600,
    "D3_D4": 400,
    "D4": 250,
  };

  campoHU.value = mappa[valore] || "";
}


function salvaDati() {
  const nome = document.getElementById('nome').value || 'paziente';
  const num = document.getElementById('impianti').value;
  if (!num) {
    alert("Inserisci almeno un impianto prima di salvare.");
    return;
  }

  const dati = {
    paziente: nome,
    impianti: []
  };

  for (let i = 0; i < num; i++) {
    dati.impianti.push({
      dente: document.getElementById(`dente_${i}`).value,
      hu: document.getElementById(`hu_${i}`).value,
      carico: document.getElementById(`carico_${i}`).value,
      post: document.getElementById(`post_${i}`).value,
      b1one: document.getElementById(`b1one_${i}`).value,
      diametro: document.getElementById(`diametro_${i}`).value,
      lunghezza: document.getElementById(`lunghezza_${i}`).value
    });
  }

  const blob = new Blob([JSON.stringify(dati, null, 2)], { type: "application/json" });
  const url = URL.createObjectURL(blob);
  const a = document.createElement("a");
  a.href = url;
  a.download = `Dati_${nome.replace(/\s+/g, "_")}.json`;
  a.click();
  URL.revokeObjectURL(url);
}


function caricaDati(event) {
  const file = event.target.files[0];
  if (!file) return;

  const reader = new FileReader();
  reader.onload = function(e) {
    try {
      const dati = JSON.parse(e.target.result);
      document.getElementById('nome').value = dati.paziente || '';
      document.getElementById('impianti').value = dati.impianti.length;
      creaCampiImpianti();

      setTimeout(() => {
        dati.impianti.forEach((impianto, i) => {
          document.getElementById(`dente_${i}`).value = impianto.dente || '';
          document.getElementById(`hu_${i}`).value = impianto.hu || '';
          document.getElementById(`carico_${i}`).value = impianto.carico || '';
          document.getElementById(`post_${i}`).value = impianto.post || '';
          document.getElementById(`b1one_${i}`).value = impianto.b1one || '';
          document.getElementById(`diametro_${i}`).value = impianto.diametro || '';
          aggiornaTutto(i);
    aggiornaOpzioniLunghezza(i);
          document.getElementById(`lunghezza_${i}`).value = impianto.lunghezza || '';
        });
      }, 100);
    } catch (err) {
      alert("Errore nel file caricato. Verifica che sia un file JSON valido.");
    }
  };
  reader.readAsText(file);
}


function getImpiantoIdealeLabel(densita, diametro) {
  let tipo = "";
  if (["D1", "D2 tendente D1", "D2", "D2 ‚Üí D1"].includes(densita)) tipo = "High";
  else if (["D3", "D3 tendente D2", "D3 ‚Üí D2"].includes(densita)) tipo = "Medium";
  else if (["D4", "D4 tendente D3", "D3 ‚Üí D4"].includes(densita)) tipo = "Low";
  else tipo = "ND";

  const colori = {
    "High": "red",
    "Medium": "orange",
    "Low": "green",
    "ND": "black"
  };

  return `<p style="color:${colori[tipo]}; font-weight:bold;"><strong>Impianto ideale:</strong> B1One ${tipo}</p>`;
}


function esportaProtocolliPDF() {
  const editor = document.getElementById('tabelleEditor');
  if (!editor) {
    alert("Editor non trovato.");
    return;
  }

  html2canvas(editor, { scale: 2 }).then(canvas => {
    const imgData = canvas.toDataURL('image/jpeg', 1.0);
    const pdf = new jspdf.jsPDF('p', 'mm', 'a4');
    const pageWidth = pdf.internal.pageSize.getWidth();
    const pageHeight = pdf.internal.pageSize.getHeight();
    const imgProps = pdf.getImageProperties(imgData);
    const imgHeight = (imgProps.height * (pageWidth - 20)) / imgProps.width;

    let position = 0;

    while (position < imgHeight) {
      pdf.addImage(imgData, 'JPEG', 10, -position, pageWidth - 20, imgHeight);
      position += pageHeight;
      if (position < imgHeight) pdf.addPage();
    }

    pdf.save("Protocolli_Impianti_B1One.pdf");
  });
}

</script>


<div id="editorProtocolli" style="display:none; position:fixed; top:5%; left:50%; transform:translateX(-50%); width:90%; max-height:90vh; overflow-y:auto; background:white; border:2px solid #007acc; border-radius:10px; padding:20px; z-index:9999; box-shadow:0 0 20px rgba(0,0,0,0.2);">
    <h3 style="text-align:center; color:#007acc;">Editor Protocolli</h3>
    <div id="tabelleEditor"></div>
    <div style="text-align:center; margin-top:10px;">
      <button onclick="salvaProtocolliJSON()">üíæ Salva Dati</button>
      <button onclick="document.getElementById('fileProtocollo').click()">üìÇ Carica Dati</button>
      <button onclick="applicaProtocolli()">üîÅ Aggiorna Dati</button>
      <button onclick="esportaProtocolliPDF()">üìÑ Esporta PDF</button>
      <button onclick="chiudiEditorProtocolli()" style="background:#dc3545; color:white;">Chiudi</button>
      <input type="file" id="fileProtocollo" style="display:none;" accept=".json" onchange="caricaProtocolliJSON(event)">
    </div>
  </div>

<script>
const densita = ["D1", "D2 tendente D1", "D2", "D3 tendente D2", "D3", "D4 tendente D3", "D4"];
const carichi = ["compresso", "non compresso"];
const impianti = ["2.7|High", "3.2|High", "3.7|High", "3.7|Medium", "3.7|Low", "4.2|High", "4.2|Medium", "4.2|Low", "4.8|Medium", "4.8|Low"];
let protocolloEditable = {};

function getDensitaFromHU(hu) {
  if (hu > 1250) return "D1";
  if (hu >= 1150) return "D2 tendente D1";
  if (hu >= 850) return "D2";
  if (hu >= 700) return "D3 tendente D2";
  if (hu >= 500) return "D3";
  if (hu >= 300) return "D4 tendente D3";
  return "D4";
}

function getPreparazioneDaEditor(diametro, tipo, hu, carico) {
  const densita = getDensitaFromHU(hu);
  const chiave = `${diametro}|${tipo}`;
  const fallback = { fresa: "ND", prep: "ND" };
  return protocolloEditable?.[chiave]?.[densita]?.[carico] || fallback;
}


impianti.forEach(imp => {
  protocolloEditable[imp] = {};
  densita.forEach(d => {
    protocolloEditable[imp][d] = {};
    carichi.forEach(c => {
      protocolloEditable[imp][d][c] = { fresa: "", prep: "" };
    });
  });
});

window.mostraEditorProtocolli = function () {
  const contenitore = document.getElementById("tabelleEditor");
  contenitore.innerHTML = "";
  for (let impianto in protocolloEditable) {
    const [diametro, tipo] = impianto.split("|");
    let html = `<table><thead><tr><th colspan="4" style="background:#e3f2fd;">√ò${diametro} ‚Äì ${tipo}</th></tr>
                <tr><th>Densit√†</th><th>Carico</th><th>Fresa √ò</th><th>Preparazione</th></tr></thead><tbody>`;
    densita.forEach(d => {
      carichi.forEach(c => {
        const val = protocolloEditable[impianto][d][c];
        html += `<tr><td>${d}</td><td>${c}</td>
        <td><input type="text" value="${val.fresa}" onchange="protocolloEditable['${impianto}']['${d}']['${c}'].fresa=this.value"></td>
        <td><input type="text" value="${val.prep}" onchange="protocolloEditable['${impianto}']['${d}']['${c}'].prep=this.value"></td></tr>`;
      });
    });
    html += "</tbody></table><br>";
    contenitore.innerHTML += html;
  }
  document.getElementById("editorProtocolli").style.display = "block";
};

window.chiudiEditorProtocolli = function () {
  document.getElementById("editorProtocolli").style.display = "none";
};

window.salvaProtocolliJSON = function () {
  const blob = new Blob([JSON.stringify(protocolloEditable, null, 2)], { type: "application/json" });
  const url = URL.createObjectURL(blob);
  const a = document.createElement("a");
  a.href = url;
  a.download = "Protocolli_B1One.json";
  a.click();
  URL.revokeObjectURL(url);
};

window.caricaProtocolliJSON = function (event) {
  const file = event.target.files[0];
  if (!file) return;
  const reader = new FileReader();
  reader.onload = e => {
    try {
      protocolloEditable = JSON.parse(e.target.result);
      mostraEditorProtocolli();
    } catch {
      alert("Errore nel file JSON");
    }
  };
  reader.readAsText(file);
};

window.applicaProtocolli = function () {
  alert("‚úÖ Protocolli aggiornati nel software.");
};

function getImpiantoIdealeLabel(densita, diametro) {
  let tipo = "";
  if (["D1", "D2 tendente D1", "D2", "D2 ‚Üí D1"].includes(densita)) tipo = "High";
  else if (["D3", "D3 tendente D2", "D3 ‚Üí D2"].includes(densita)) tipo = "Medium";
  else if (["D4", "D4 tendente D3", "D3 ‚Üí D4"].includes(densita)) tipo = "Low";
  else tipo = "ND";

  const colori = {
    "High": "red",
    "Medium": "orange",
    "Low": "green",
    "ND": "black"
  };

  return `<p style="color:${colori[tipo]}; font-weight:bold;"><strong>Impianto ideale:</strong> B1One ${tipo}</p>`;
}


function esportaProtocolliPDF() {
  const editor = document.getElementById('tabelleEditor');
  if (!editor) {
    alert("Editor non trovato.");
    return;
  }

  html2canvas(editor, { scale: 2 }).then(canvas => {
    const imgData = canvas.toDataURL('image/jpeg', 1.0);
    const pdf = new jspdf.jsPDF('p', 'mm', 'a4');
    const pageWidth = pdf.internal.pageSize.getWidth();
    const pageHeight = pdf.internal.pageSize.getHeight();
    const imgProps = pdf.getImageProperties(imgData);
    const imgHeight = (imgProps.height * (pageWidth - 20)) / imgProps.width;

    let position = 0;

    while (position < imgHeight) {
      pdf.addImage(imgData, 'JPEG', 10, -position, pageWidth - 20, imgHeight);
      position += pageHeight;
      if (position < imgHeight) pdf.addPage();
    }

    pdf.save("Protocolli_Impianti_B1One.pdf");
  });
}

</script>

<div id="risultati" style="margin:30px 0;"></div>


<script>
function aggiornaOpzioniB1One(index) {
  const diametro = document.getElementById(`diametro_${index}`)?.value;
  const select = document.getElementById(`b1one_${index}`);
  if (!select || !diametro) return;

  select.innerHTML = ""; // svuota le opzioni
  const val = parseFloat(diametro);

  if (val === 2.7 || val === 3.2) {
    const optHigh = document.createElement("option");
    optHigh.value = "High";
    optHigh.textContent = "High";
    select.appendChild(optHigh);
  } else if (val === 4.8) {
    const optMedium = document.createElement("option");
    optMedium.value = "Medium";
    optMedium.textContent = "Medium";
    select.appendChild(optMedium);
    const optLow = document.createElement("option");
    optLow.value = "Low";
    optLow.textContent = "Low";
    select.appendChild(optLow);
  } else {
    const optHigh = document.createElement("option");
    optHigh.value = "High";
    optHigh.textContent = "High";
    select.appendChild(optHigh);
    const optMedium = document.createElement("option");
    optMedium.value = "Medium";
    optMedium.textContent = "Medium";
    select.appendChild(optMedium);
    const optLow = document.createElement("option");
    optLow.value = "Low";
    optLow.textContent = "Low";
    select.appendChild(optLow);
  }
}

function getImpiantoIdealeLabel(densita, diametro) {
  let tipo = "";
  if (["D1", "D2 tendente D1", "D2", "D2 ‚Üí D1"].includes(densita)) tipo = "High";
  else if (["D3", "D3 tendente D2", "D3 ‚Üí D2"].includes(densita)) tipo = "Medium";
  else if (["D4", "D4 tendente D3", "D3 ‚Üí D4"].includes(densita)) tipo = "Low";
  else tipo = "ND";

  const colori = {
    "High": "red",
    "Medium": "orange",
    "Low": "green",
    "ND": "black"
  };

  return `<p style="color:${colori[tipo]}; font-weight:bold;"><strong>Impianto ideale:</strong> B1One ${tipo}</p>`;
}


function esportaProtocolliPDF() {
  const editor = document.getElementById('tabelleEditor');
  if (!editor) {
    alert("Editor non trovato.");
    return;
  }

  html2canvas(editor, { scale: 2 }).then(canvas => {
    const imgData = canvas.toDataURL('image/jpeg', 1.0);
    const pdf = new jspdf.jsPDF('p', 'mm', 'a4');
    const pageWidth = pdf.internal.pageSize.getWidth();
    const pageHeight = pdf.internal.pageSize.getHeight();
    const imgProps = pdf.getImageProperties(imgData);
    const imgHeight = (imgProps.height * (pageWidth - 20)) / imgProps.width;

    let position = 0;

    while (position < imgHeight) {
      pdf.addImage(imgData, 'JPEG', 10, -position, pageWidth - 20, imgHeight);
      position += pageHeight;
      if (position < imgHeight) pdf.addPage();
    }

    pdf.save("Protocolli_Impianti_B1One.pdf");
  });
}

</script>






<script>
function aggiornaOpzioniLunghezza(index) {
  const diametro = parseFloat(document.getElementById(`diametro_${index}`)?.value);
  const select = document.getElementById(`lunghezza_${index}`);
  if (!select || !diametro) return;

  select.innerHTML = "";

  const tutte = ["6", "8", "10", "11.5", "13", "15.5"];
  const da10 = ["10", "11.5", "13", "15.5"];
  const da8 = ["8", "10", "11.5", "13", "15.5"];
  const tutteNo155 = ["6", "8", "10", "11.5", "13"];

  let lista = tutte;
  if (diametro === 2.7 || diametro === 3.2) {
    lista = [...da10];
  } else if (diametro === 3.7) {
    lista = [...da8];
  } else if (diametro === 4.8) {
    lista = [...tutteNo155];
  }

  // Aggiungi 17 mm solo per diametri selezionati
  if ([2.7, 3.2, 3.7, 4.2].includes(diametro)) {
    lista.push("17");
  }

  lista.forEach(len => {
    const opt = document.createElement("option");
    opt.value = len;
    opt.textContent = len + " mm";
    select.appendChild(opt);
  });
}

function getImpiantoIdealeLabel(densita, diametro) {
  let tipo = "";
  if (["D1", "D2 tendente D1", "D2", "D2 ‚Üí D1"].includes(densita)) tipo = "High";
  else if (["D3", "D3 tendente D2", "D3 ‚Üí D2"].includes(densita)) tipo = "Medium";
  else if (["D4", "D4 tendente D3", "D3 ‚Üí D4"].includes(densita)) tipo = "Low";
  else tipo = "ND";

  const colori = {
    "High": "red",
    "Medium": "orange",
    "Low": "green",
    "ND": "black"
  };

  return `<p style="color:${colori[tipo]}; font-weight:bold;"><strong>Impianto ideale:</strong> B1One ${tipo}</p>`;
}


function esportaProtocolliPDF() {
  const editor = document.getElementById('tabelleEditor');
  if (!editor) {
    alert("Editor non trovato.");
    return;
  }

  html2canvas(editor, { scale: 2 }).then(canvas => {
    const imgData = canvas.toDataURL('image/jpeg', 1.0);
    const pdf = new jspdf.jsPDF('p', 'mm', 'a4');
    const pageWidth = pdf.internal.pageSize.getWidth();
    const pageHeight = pdf.internal.pageSize.getHeight();
    const imgProps = pdf.getImageProperties(imgData);
    const imgHeight = (imgProps.height * (pageWidth - 20)) / imgProps.width;

    let position = 0;

    while (position < imgHeight) {
      pdf.addImage(imgData, 'JPEG', 10, -position, pageWidth - 20, imgHeight);
      position += pageHeight;
      if (position < imgHeight) pdf.addPage();
    }

    pdf.save("Protocolli_Impianti_B1One.pdf");
  });
}

</script>




</body>

</html>
